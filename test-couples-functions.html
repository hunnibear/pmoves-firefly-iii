<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Couples Dashboard Function Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <meta name="csrf-token" content="test-token">
</head>
<body>
    <div class="container mt-4">
        <h1>Couples Dashboard Function Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>Test Buttons</h3>
                <div class="btn-group-vertical d-grid gap-2">
                    <button class="btn btn-primary" onclick="openAddTransactionModal()">
                        <i class="fas fa-plus"></i> Add Transaction
                    </button>
                    <button class="btn btn-secondary" onclick="openReceiptUpload()">
                        <i class="fas fa-camera"></i> Upload Receipt
                    </button>
                    <button class="btn btn-info" onclick="runAIAnalysis()">
                        <i class="fas fa-brain"></i> AI Analysis
                    </button>
                    <button class="btn btn-success" onclick="openGoalsModal()">
                        <i class="fas fa-target"></i> Goals
                    </button>
                    <button class="btn btn-warning" onclick="openImportModal()">
                        <i class="fas fa-file-import"></i> Import
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshTransactions()">
                        <i class="fas fa-refresh"></i> Refresh
                    </button>
                </div>
            </div>
            
            <div class="col-md-6">
                <h3>Debug Console</h3>
                <div id="debug-output" class="border p-3" style="height: 300px; overflow-y: auto; background: #f8f9fa;">
                    <div>Console output will appear here...</div>
                </div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="testAllFunctions()">Test All Functions</button>
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearDebug()">Clear</button>
            </div>
        </div>
    </div>

    <!-- Required modals (simplified) -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">Test modal content</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="goalsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Goals</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">Goals modal content</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">Import modal content</div>
            </div>
        </div>
    </div>

    <script>
        // Debug console
        function debugLog(message) {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearDebug() {
            document.getElementById('debug-output').innerHTML = '<div>Console cleared...</div>';
        }

        // Override console.log and console.error for debugging
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            debugLog('LOG: ' + args.join(' '));
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            debugLog('ERROR: ' + args.join(' '));
            originalError.apply(console, args);
        };

        // Mock CouplesEnhancedDashboard for testing
        class CouplesEnhancedDashboard {
            constructor() {
                console.log('CouplesEnhancedDashboard initialized');
            }

            uploadReceipt(file) {
                console.log('Upload receipt called with file:', file.name);
                return Promise.resolve({success: true});
            }

            runAIAnalysis() {
                console.log('AI Analysis called');
            }

            loadCouplesData() {
                console.log('Load couples data called');
                return Promise.resolve();
            }

            submitTransaction() {
                console.log('Submit transaction called');
            }

            createTransactionFromReceipt(data) {
                console.log('Create transaction from receipt called with data:', data);
            }

            showError(message) {
                console.error('App error:', message);
            }

            showSuccess(message) {
                console.log('App success:', message);
            }

            showNotification(message, type) {
                console.log(`Notification (${type}):`, message);
            }
        }

        // Global functions (copied from dashboard)
        function openAddTransactionModal() {
            try {
                debugLog('Opening add transaction modal...');
                const modal = new bootstrap.Modal(document.getElementById('addTransactionModal'));
                modal.show();
                debugLog('Add transaction modal opened successfully');
            } catch (error) {
                debugLog('Error opening add transaction modal: ' + error.message);
            }
        }

        function openReceiptUpload() {
            try {
                debugLog('Opening receipt upload...');
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*,application/pdf';
                fileInput.onchange = async (e) => {
                    if (e.target.files.length > 0) {
                        debugLog('File selected: ' + e.target.files[0].name);
                        if (window.couplesApp && typeof window.couplesApp.uploadReceipt === 'function') {
                            await window.couplesApp.uploadReceipt(e.target.files[0]);
                        } else {
                            debugLog('CouplesApp not ready for file upload');
                        }
                    }
                };
                fileInput.click();
                debugLog('File input opened');
            } catch (error) {
                debugLog('Error opening receipt upload: ' + error.message);
            }
        }

        function runAIAnalysis() {
            try {
                debugLog('Running AI analysis...');
                if (window.couplesApp && typeof window.couplesApp.runAIAnalysis === 'function') {
                    window.couplesApp.runAIAnalysis();
                    debugLog('AI analysis completed');
                } else {
                    debugLog('CouplesApp not ready for AI analysis');
                }
            } catch (error) {
                debugLog('Error running AI analysis: ' + error.message);
            }
        }

        function openGoalsModal() {
            try {
                debugLog('Opening goals modal...');
                const modal = new bootstrap.Modal(document.getElementById('goalsModal'));
                modal.show();
                debugLog('Goals modal opened successfully');
            } catch (error) {
                debugLog('Error opening goals modal: ' + error.message);
            }
        }

        function openImportModal() {
            try {
                debugLog('Opening import modal...');
                const modal = new bootstrap.Modal(document.getElementById('importModal'));
                modal.show();
                debugLog('Import modal opened successfully');
            } catch (error) {
                debugLog('Error opening import modal: ' + error.message);
            }
        }

        function refreshTransactions() {
            try {
                debugLog('Refreshing transactions...');
                if (window.couplesApp && typeof window.couplesApp.loadCouplesData === 'function') {
                    window.couplesApp.loadCouplesData();
                    debugLog('Transactions refreshed');
                } else {
                    debugLog('CouplesApp not ready, would reload page');
                }
            } catch (error) {
                debugLog('Error refreshing transactions: ' + error.message);
            }
        }

        function testAllFunctions() {
            debugLog('=== Testing All Functions ===');
            
            const functions = [
                'openAddTransactionModal',
                'openReceiptUpload', 
                'runAIAnalysis',
                'openGoalsModal',
                'openImportModal',
                'refreshTransactions'
            ];

            functions.forEach(funcName => {
                try {
                    debugLog(`Testing ${funcName}...`);
                    if (typeof window[funcName] === 'function') {
                        debugLog(`✓ ${funcName} is defined and callable`);
                    } else {
                        debugLog(`✗ ${funcName} is not defined`);
                    }
                } catch (error) {
                    debugLog(`✗ ${funcName} error: ${error.message}`);
                }
            });

            debugLog('=== Function Test Complete ===');
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            try {
                debugLog('Initializing test environment...');
                window.couplesApp = new CouplesEnhancedDashboard();
                debugLog('Test environment initialized successfully');
                
                // Test that all functions are available
                setTimeout(() => {
                    testAllFunctions();
                }, 1000);
                
            } catch (error) {
                debugLog('Failed to initialize test environment: ' + error.message);
            }
        });
    </script>
</body>
</html>